import { fileModel } from './models/File'
import { generateFileService } from './services/File'
import { generateFileResolver } from './resolvers/File'
import { connectFileApi } from './api/File'

import { productModel } from './models/Product'
import { generateProductService } from './services/Product'
import { generateProductResolver } from './resolvers/Product'
import { connectProductApi } from './api/Product'

import { userModel } from './models/User'
import { generateUserService } from './services/User'
import { generateUserResolver } from './resolvers/User'
import { connectUserApi } from './api/User'

import { userRoleModel } from './models/UserRole'
import { generateUserRoleService } from './services/UserRole'
import { generateUserRoleResolver } from './resolvers/UserRole'
import { connectUserRoleApi } from './api/UserRole'

import { generateDataloaders } from './dataloaders'
import { apiMiddleware } from './api-utils'
import * as extras from './extras'
import { registerStorageService } from './storage'

let hooks

try {
    hooks = require(`${process.cwd()}/services/entryHooks.ts`).hooks
} catch (ex) {
    if (ex.code == 'MODULE_NOT_FOUND') {
        hooks = {}
        console.log(`missing ${process.cwd()}/services/entryHooks.ts`)
    } else {
        console.error(ex)
        throw ex
    }
}

export const generateResolver = (setting = {}) => {
    const entry = {
        models: {},
        services: {},
        resolvers: {},
        dataloaders: {},
        hooks: {
            api: {},
            services: {},
            resolvers: {},
        },
        storage: {} as ReturnType<typeof registerStorageService>,
    }

    if (hooks.services) {
        for (const serviceHookName in hooks.services) {
            entry.hooks.services[serviceHookName] = hooks.services[serviceHookName]
        }
    }

    if (hooks.resolvers) {
        for (const serviceHookName in hooks.resolvers) {
            entry.hooks.resolvers[serviceHookName] = hooks.resolvers[serviceHookName]
        }
    }

    entry.models['file'] = fileModel
entry.models['product'] = productModel
entry.models['user'] = userModel
entry.models['userRole'] = userRoleModel

    entry.services['file'] = generateFileService(entry)
entry.services['product'] = generateProductService(entry)
entry.services['user'] = generateUserService(entry)
entry.services['userRole'] = generateUserRoleService(entry)

    entry.resolvers['file'] = generateFileResolver(entry)
entry.resolvers['product'] = generateProductResolver(entry)
entry.resolvers['user'] = generateUserResolver(entry)
entry.resolvers['userRole'] = generateUserRoleResolver(entry)


    generateDataloaders(entry)

    const resolvers = 
  {
    Query:{
      		File: entry.resolvers['file'].one,
		allFile: entry.resolvers['file'].all,
		countFile: entry.resolvers['file'].count,
		Product: entry.resolvers['product'].one,
		allProduct: entry.resolvers['product'].all,
		countProduct: entry.resolvers['product'].count,
		User: entry.resolvers['user'].one,
		allUser: entry.resolvers['user'].all,
		countUser: entry.resolvers['user'].count,
		UserRole: entry.resolvers['userRole'].one,
		allUserRole: entry.resolvers['userRole'].all,
		countUserRole: entry.resolvers['userRole'].count,

    },
    Mutation:{
      		createFile: entry.resolvers['file'].create,
		updateFile: entry.resolvers['file'].update,
		removeFile: entry.resolvers['file'].remove,
		createProduct: entry.resolvers['product'].create,
		updateProduct: entry.resolvers['product'].update,
		removeProduct: entry.resolvers['product'].remove,
		updateUser: entry.resolvers['user'].update,
		removeUser: entry.resolvers['user'].remove,
		addRoleToUser: entry.resolvers['user'].addRoleToUser,
		removeRoleFromUser: entry.resolvers['user'].removeRoleFromUser,
		createUserRole: entry.resolvers['userRole'].create,
		updateUserRole: entry.resolvers['userRole'].update,
		removeUserRole: entry.resolvers['userRole'].remove,

      // generated by entry.ts
      login_v1: extras.generateLogin(entry),
      register_v1: extras.generateRegister(entry),
      logout_v1: extras.generateLogout(entry),
      refreshToken_v1: extras.generateRefreshToken(entry),
      changePassword_v1: extras.generateChangePassword(entry),
      forgottenPassword_v1: extras.generateForgottenPassword(entry),
      forgottenPasswordCheck_v1: extras.generateForgottenPasswordCheck(entry),
      forgottenPasswordReset_v1: extras.generateForgottenPasswordReset(entry),
      verifyEmail_v1: extras.generateVerify(entry),
      verifyEmailResend_v1: extras.generateVerifyEmailResend(entry)
    }
    ,FileModel: {
    user: async (userModel, data, koaContext) => {
      return entry.dataloaders['user'](koaContext, userModel.user,false)
    },
    data: async (fileModel, data, koaContext) => {
      return entry.storage.loadDataFromFile(fileModel, data, koaContext)
    },    
}

,ProductModel: {
    user: async (userModel, data, koaContext) => {
      return entry.dataloaders['user'](koaContext, userModel.user,false)
    },    
}

,UserModel: {
    roles: async (userRoleModel, data, koaContext) => {
      return entry.dataloaders['userRole'](koaContext, userRoleModel.roles,true)
    },
    files: async (fileModel, data, koaContext) => {
      return entry.dataloaders['file'](koaContext, fileModel.files,true)
    },
    _product: async (productModel, data, koaContext) => {
      return entry.dataloaders['product'](koaContext, productModel._product,true)
    },    
}
,AddRoleToUserResult:{
                user: async (userModel, data, koaContext) => {
                    return  entry.dataloaders['user'](koaContext, userModel.userId,true)
                  },
                userRole: async (userRoleModel, data, koaContext) => {
                    return  entry.dataloaders['userRole'](koaContext, userRoleModel.userRoleId,true)
                  }
            }
    
,UserRoleModel: {
    users: async (userModel, data, koaContext) => {
      return entry.dataloaders['user'](koaContext, userModel.users,true)
    },    
}


  }
  

    return {
        entry,
        resolvers,
    }
}

export function connectApi(apiRouter, entry) {
    //apiRouter.use(apiMiddleware)
    connectFileApi(apiRouter, entry)
connectProductApi(apiRouter, entry)
connectUserApi(apiRouter, entry)
connectUserRoleApi(apiRouter, entry)

}
